% Print marker from average data file instead of the last point
%
% Draw a solid line at the median and keep the variance semi-transparent
% Raw data should be marks only?
%
%
%


\documentclass[tikz]{standalone}
\usepackage{mathptmx}

\usepackage{varwidth}
\usepackage{pgfplots}
\pgfplotsset{compat=1.15}
\usepgfplotslibrary{units}
\usepgfplotslibrary{colorbrewer}

\usetikzlibrary{decorations.markings}
\usetikzlibrary{arrows,fit,calc,angles,quotes}

\usepackage{tikz-3dplot}
\usepackage{tkz-fct}
\usepackage{siunitx}
\usepackage{pgfplotstable}
\usepgfplotslibrary{groupplots}

\usepackage{booktabs}

\pgfplotsset{
    mark last*/.style={
        scatter,
        scatter src=x,
        scatter/@pre marker code/.code={
            \pgfmathtruncatemacro\usemark{
                (\coordindex==(\numcoords-1))
            }
            \ifnum\usemark=0
                \pgfplotsset{mark=none}
            \fi
        },
        scatter/@post marker code/.code={}
    }
}

\begin{filecontents}{avg.dat}
t
1
\end{filecontents}






\definecolor{Dark2-3-1}{RGB}{27,158,119}
\definecolor{Dark2-3-A}{RGB}{27,158,119}
\definecolor{Dark2-3-2}{RGB}{217,95,2}
\definecolor{Dark2-3-B}{RGB}{217,95,2}
\definecolor{Dark2-3-3}{RGB}{117,112,179}
\definecolor{Dark2-3-C}{RGB}{117,112,179}
\definecolor{Dark2-4-1}{RGB}{27,158,119}
\definecolor{Dark2-4-A}{RGB}{27,158,119}
\definecolor{Dark2-4-2}{RGB}{217,95,2}
\definecolor{Dark2-4-B}{RGB}{217,95,2}
\definecolor{Dark2-4-3}{RGB}{117,112,179}
\definecolor{Dark2-4-C}{RGB}{117,112,179}
\definecolor{Dark2-4-4}{RGB}{231,41,138}
\definecolor{Dark2-4-D}{RGB}{231,41,138}
\definecolor{Dark2-5-1}{RGB}{27,158,119}
\definecolor{Dark2-5-A}{RGB}{27,158,119}
\definecolor{Dark2-5-2}{RGB}{217,95,2}
\definecolor{Dark2-5-B}{RGB}{217,95,2}
\definecolor{Dark2-5-3}{RGB}{117,112,179}
\definecolor{Dark2-5-C}{RGB}{117,112,179}
\definecolor{Dark2-5-4}{RGB}{231,41,138}
\definecolor{Dark2-5-D}{RGB}{231,41,138}
\definecolor{Dark2-5-5}{RGB}{102,166,30}
\definecolor{Dark2-5-E}{RGB}{102,166,30}
\definecolor{Dark2-6-1}{RGB}{27,158,119}
\definecolor{Dark2-6-A}{RGB}{27,158,119}
\definecolor{Dark2-6-2}{RGB}{217,95,2}
\definecolor{Dark2-6-B}{RGB}{217,95,2}
\definecolor{Dark2-6-3}{RGB}{117,112,179}
\definecolor{Dark2-6-C}{RGB}{117,112,179}
\definecolor{Dark2-6-4}{RGB}{231,41,138}
\definecolor{Dark2-6-D}{RGB}{231,41,138}
\definecolor{Dark2-6-5}{RGB}{102,166,30}
\definecolor{Dark2-6-E}{RGB}{102,166,30}
\definecolor{Dark2-6-6}{RGB}{230,171,2}
\definecolor{Dark2-6-F}{RGB}{230,171,2}
\definecolor{Dark2-7-1}{RGB}{27,158,119}
\definecolor{Dark2-7-A}{RGB}{27,158,119}
\definecolor{Dark2-7-2}{RGB}{217,95,2}
\definecolor{Dark2-7-B}{RGB}{217,95,2}
\definecolor{Dark2-7-3}{RGB}{117,112,179}
\definecolor{Dark2-7-C}{RGB}{117,112,179}
\definecolor{Dark2-7-4}{RGB}{231,41,138}
\definecolor{Dark2-7-D}{RGB}{231,41,138}
\definecolor{Dark2-7-5}{RGB}{102,166,30}
\definecolor{Dark2-7-E}{RGB}{102,166,30}
\definecolor{Dark2-7-6}{RGB}{230,171,2}
\definecolor{Dark2-7-F}{RGB}{230,171,2}
\definecolor{Dark2-7-7}{RGB}{166,118,29}
\definecolor{Dark2-7-G}{RGB}{166,118,29}
\definecolor{Dark2-8-1}{RGB}{27,158,119}
\definecolor{Dark2-8-A}{RGB}{27,158,119}
\definecolor{Dark2-8-2}{RGB}{217,95,2}
\definecolor{Dark2-8-B}{RGB}{217,95,2}
\definecolor{Dark2-8-3}{RGB}{117,112,179}
\definecolor{Dark2-8-C}{RGB}{117,112,179}
\definecolor{Dark2-8-4}{RGB}{231,41,138}
\definecolor{Dark2-8-D}{RGB}{231,41,138}
\definecolor{Dark2-8-5}{RGB}{102,166,30}
\definecolor{Dark2-8-E}{RGB}{102,166,30}
\definecolor{Dark2-8-6}{RGB}{230,171,2}
\definecolor{Dark2-8-F}{RGB}{230,171,2}
\definecolor{Dark2-8-7}{RGB}{166,118,29}
\definecolor{Dark2-8-G}{RGB}{166,118,29}
\definecolor{Dark2-8-8}{RGB}{102,102,102}
\definecolor{Dark2-8-H}{RGB}{102,102,102}



\begin{document}

\def\figWidth{14cm}
\def\polMark{mark=pentagon*}
\def\baseMark{mark=x,}

\newcommand{\testLine}[2]{%
	\addplot+[%
		forget plot,
		color = Dark2-5-#2,
% 		only marks,
% 		opacity=0.5,
% 		mark options={scale=0.2},
		opacity=0.25,
	] table[%
		x=TimeInSeconds, 
		col sep=comma,
% 		y=MsUntilRenderComplete,
		y=MsBetweenPresents,
% 		y expr= (1000/(\thisrowno{11})),
	] {#1};
}

\newcommand{\testLineMark}[1]{%
	\addplot+[%
		forget plot,
% 		opacity=0.5,
		mark=o,
		mark last*,
		mark size=6pt,
	] table[%
		x=TimeInSeconds, 
		col sep=comma,
% 		y=MsUntilRenderComplete,
		y=MsBetweenPresents,
% 		y expr= (1000/(\thisrowno{11})),
	] {#1};
}

%1: input table, 2: input column, 3: output table, 4: output column
\newcommand{\copycolumn}[4]{
\pgfplotstablecreatecol[                                                                                                
         col sep=comma,
         create col/copy column from table={#1}{#2}                                                      
         ]{#4}{#3}   
}

\newcommand*{\ReadOutElement}[4]{%
    \pgfplotstablegetelem{#2}{#3}\of{#1}%
    \let#4\pgfplotsretval
}

\newcommand{\getVal}[2]{%
	\pgfplotstablegetelement{[index]1}{#2}\of{#1}
}

\def\Scene{Arcade}
% \def\Scene{Temple}
% \def\Scene{Bistro}

% \def\toVal{(1024.0*1024.0)}
\def\MiB{1048576} % to MiB
\def\KiB{1024} % to KiB
\def\toVal{\MiB}

\def\numberNames{{X,A,B,C,D,E}}

\newcommand\storelabel[2]{\expandafter\xdef\csname label#1\endcsname{#2}}
\newcommand\getlabel[1]{\csname label#1\endcsname}

% 1: recursions, 2: Scene, 3: type
\newcommand{\getAvg}[3]{

\pgfkeys{/pgf/fpu}
	\pgfplotstableread[col sep=comma]{C:/Users/nalo/Desktop/TestsCopy/VRAM#1/#3#2#1_run1.csv}\datafile
    	\pgfplotstablegetelem{0}{Usage (B)}\of\datafile
	\pgfmathsetmacro{\testValA}{\pgfplotsretval/\toVal}
	\pgfplotstableread[col sep=comma]{C:/Users/nalo/Desktop/TestsCopy/VRAM#1/#3#2#1_run2.csv}\datafile
  	\pgfplotstablegetelem{0}{Usage (B)}\of\datafile
	\pgfmathsetmacro{\testValB}{\pgfplotsretval/\toVal}
	\pgfplotstableread[col sep=comma]{C:/Users/nalo/Desktop/TestsCopy/VRAM#1/#3#2#1_run3.csv}\datafile
    	\pgfplotstablegetelem{0}{Usage (B)}\of\datafile
	\pgfmathsetmacro{\testValC}{\pgfplotsretval/\toVal}
	\pgfmathsetmacro{\temp}{(\testValA+\testValB+\testValC)/3.0}
	
	\storelabel{#3#2#1}{\temp}
\pgfkeys{/pgf/fpu=false}
}

% 1: recursions, 2: Scene
\newcommand{\getIncrease}[2]{
	100.0*\getlabel{Polarized#2#1}/\getlabel{Baseline#2#1}-100.0
}

% 1: recursions, 2: Scene
\newcommand{\getDiff}[2]{
	\getlabel{Polarized#2#1} - \getlabel{Baseline#2#1}
}

% 4,044,697,600 B
%       3,949,900 KiB
%              3,857 MiB

\newcommand{\AVERAGE}{}%
\newcommand{\TABLE}{}%

\begin{tikzpicture}

\ifdefined\TABLE

\pgfplotsinvokeforeach{5,4,3,2,1}{
		\getAvg{#1}{Arcade}{Baseline}
		\getAvg{#1}{Temple}{Baseline}
		\getAvg{#1}{Bistro}{Baseline}
		
		\getAvg{#1}{Arcade}{Polarized}
		\getAvg{#1}{Temple}{Polarized}
		\getAvg{#1}{Bistro}{Polarized}	
    	}

\def\test\getDiff{1}{Arcade}

\node (tab1) {%
  \begin{tabular}{ccc}
  \toprule
  ID & Ord & Event\\
  \midrule
  Ana & 1 & \test{}\\
  Tom & 1 & 1\\
  Tom & 2 & 2\\
  Tom & 3 & 3\\
  Tom & 3 & 4\\
  \bottomrule
  \end{tabular}}
};

\else
\ifdefined\AVERAGE

%VRAM Avg
\begin{axis}[%
	cycle list/Dark2,
	width=6cm,
	height=8cm,
    ymin=-5,
    ymax=20,
    xmin=0.5,
    xmax=5.5,
    xtick align=outside,
    ytick align=outside,
    minor y tick num=1,
    xtick={1,3,5},
    xticklabels={Arcade,Temple,Bistro},
    xlabel={Test scene},
    ylabel={Average frame rate (higher is better)},
    y unit=FPS,
    legend pos=north east,
    legend style={%
    	legend cell align=left, font=\scriptsize},
    	restrict x to domain*=0:5E9,
	restrict y to domain*=0:1E14,
]
	\addlegendimage{very thick, dashed, black}
	\addlegendentry{Polarized}
	\addlegendimage{very thick, black}
	\addlegendentry{Baseline}

	\addlegendimage{thick,only marks, Dark2-5-5}
	\addlegendentry{$5$ recursions}
	\addlegendimage{thick,only marks, Dark2-5-4}
	\addlegendentry{$4$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-3}
	\addlegendentry{$3$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-2}
	\addlegendentry{$2$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-1}
	\addlegendentry{$1$ rec.}
	

    	\pgfplotsinvokeforeach{5,4,3,2,1}{
		\getAvg{#1}{Arcade}{Baseline}
		\getAvg{#1}{Temple}{Baseline}
		\getAvg{#1}{Bistro}{Baseline}
		
		\getAvg{#1}{Arcade}{Polarized}
		\getAvg{#1}{Temple}{Polarized}
		\getAvg{#1}{Bistro}{Polarized}	
    	}
    	\foreach \rec in {1,2,3,4,5} {
    		\edef\drawline{\noexpand\draw[very thick,dashed,color = Dark2-5-\rec] (1, \getDiff{\rec}{Arcade}) -- (3,\getDiff{\rec}{Temple}) -- (5,\getDiff{\rec}{Bistro});}
		\drawline
    	}
    	

\end{axis}

\else

% VRAM Diff
\begin{axis}[%
	cycle list/Dark2,
	width=6cm,
	height=8cm,
    ymin=0,
    ymax=45,
    xmin=0.5,
    xmax=5.5,
    xtick align=outside,
    ytick align=outside,
    minor y tick num=1,
    xtick={1,3,5},
    xticklabels={Arcade,Temple,Bistro},
    xlabel={Test scene},
    ylabel={Average frame rate decrease (lower is better)},
    y unit=\si{\percent},
    legend pos=north east,
    legend style={%
    	legend cell align=left, font=\scriptsize},
]
	\addlegendimage{thick,only marks, Dark2-5-5}
	\addlegendentry{$5$ recursions}
	\addlegendimage{thick,only marks, Dark2-5-4}
	\addlegendentry{$4$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-3}
	\addlegendentry{$3$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-2}
	\addlegendentry{$2$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-1}
	\addlegendentry{$1$ rec.}
	

    	\pgfplotsinvokeforeach{5,4,3,2,1}{
		\getAvg{#1}{Arcade}{Baseline}
		\getAvg{#1}{Temple}{Baseline}
		\getAvg{#1}{Bistro}{Baseline}
		
		\getAvg{#1}{Arcade}{Polarized}
		\getAvg{#1}{Temple}{Polarized}
		\getAvg{#1}{Bistro}{Polarized}	
    	}
    	\foreach \rec in {1,2,3,4,5} {
    		\edef\drawline{\noexpand\draw[very thick,color = Dark2-5-\rec] (1, \getDecrease{\rec}{Arcade}) -- (3,\getDecrease{\rec}{Temple}) -- (5,\getDecrease{\rec}{Bistro});}
		\drawline
    	}
    	

\end{axis}
\fi
\fi
\end{tikzpicture}


\end{document}


ment}


    	}
    	

\end{axis}
\fi
\fi
\end{tikzpicture}


\end{document}

T{#1}{Bistro}{Polarized}	
    	}
    	\foreach \rec in {1,2,3,4,5} {
    		\edef\drawline{\noexpand\draw[very thick,color = Dark2-5-\rec] (1, \getlabel{BaselineArcade\rec}) -- (3,\getlabel{BaselineTemple\rec}) -- (5,\getlabel{BaselineBistro\rec});}
		\drawline
		\edef\drawline{\noexpand\draw[very thick,dashed,color = Dark2-5-\rec] (1, \getlabel{PolarizedArcade\rec}) -- (3,\getlabel{PolarizedTemple\rec}) -- (5,\getlabel{PolarizedBistro\rec});}
		\drawline
    	}
    	

\end{axis}
\fi
\else
\ifdefined\FPS

% FPS diff
\begin{axis}[%
	cycle list/Dark2,
	width=6cm,
	height=8cm,
    ymin=0,
    ymax=45,
    xmin=0.5,
    xmax=5.5,
    xtick align=outside,
    ytick align=outside,
    minor y tick num=1,
    xtick={1,3,5},
    xticklabels={Arcade,Temple,Bistro},
    xlabel={Test scene},
    ylabel={Average frame rate decrease (lower is better)},
    y unit=\si{\percent},
    legend pos=north east,
    legend style={%
    	legend cell align=left, font=\scriptsize},
]
	\addlegendimage{thick,only marks, Dark2-5-5}
	\addlegendentry{$5$ recursions}
	\addlegendimage{thick,only marks, Dark2-5-4}
	\addlegendentry{$4$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-3}
	\addlegendentry{$3$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-2}
	\addlegendentry{$2$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-1}
	\addlegendentry{$1$ rec.}
	

    	\pgfplotsinvokeforeach{5,4,3,2,1}{
		\getAvg{#1}{Arcade}{Baseline}
		\getAvg{#1}{Temple}{Baseline}
		\getAvg{#1}{Bistro}{Baseline}
		
		\getAvg{#1}{Arcade}{Polarized}
		\getAvg{#1}{Temple}{Polarized}
		\getAvg{#1}{Bistro}{Polarized}	
    	}
    	\foreach \rec in {1,2,3,4,5} {
    		\edef\drawline{\noexpand\draw[very thick,color = Dark2-5-\rec] (1, \getDecrease{\rec}{Arcade}) -- (3,\getDecrease{\rec}{Temple}) -- (5,\getDecrease{\rec}{Bistro});}
		\drawline
    	}
    	

\end{axis}

\else

% FT diff
\begin{axis}[%
	cycle list/Dark2,
	width=6cm,
	height=8cm,
    ymin=0,
	ymax=70,
    xmin=0.5,
    xmax=5.5,
    xtick align=outside,
    ytick align=outside,
    minor y tick num=1,
    xtick={1,3,5},
    xticklabels={Arcade,Temple,Bistro},
    xlabel={Test scene},
%     x unit=\si{\second},
    ylabel={Average frametime increase (lower is better)},
    y unit=\si{\percent},
    legend pos=north east,
    legend style={%
    	legend cell align=left, font=\scriptsize},
]
% 	\addlegendimage{very thick, black}
% 	\addlegendentry{Frametime }

	\addlegendimage{thick,only marks, Dark2-5-5}
	\addlegendentry{$5$ recursions}
	\addlegendimage{thick,only marks, Dark2-5-4}
	\addlegendentry{$4$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-3}
	\addlegendentry{$3$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-2}
	\addlegendentry{$2$ rec.}
	\addlegendimage{thick,only marks, Dark2-5-1}
	\addlegendentry{$1$ rec.}
	

    	\pgfplotsinvokeforeach{5,4,3,2,1}{
		\getAvgFT{#1}{Arcade}{Baseline}
		\getAvgFT{#1}{Temple}{Baseline}
		\getAvgFT{#1}{Bistro}{Baseline}
		
		\getAvgFT{#1}{Arcade}{Polarized}
		\getAvgFT{#1}{Temple}{Polarized}
		\getAvgFT{#1}{Bistro}{Polarized}	
    	}
 
    	\foreach \rec in {1,2,3,4,5} {
    		\edef\drawline{\noexpand\draw[very thick,color = Dark2-5-\rec] (1, \getIncrease{\rec}{Arcade}) -- (3,\getIncrease{\rec}{Temple}) -- (5,\getIncrease{\rec}{Bistro});}
		\drawline
    	}

\end{axis}
\fi
\fi

\end{tikzpicture}


\end{document}

